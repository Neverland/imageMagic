/*
 *
 * Copyright 2011, enix
 * Includes toolkit lib
 * Date: 2011-9-14
 * lastmodified: 2011-12-20
 * http://www.cnblogs.com/enix
 */
delete function(b,c){var a=function(){var d=arguments.callee,f=document,e=this;d.prototype={slice:([]).slice,is:function(g){return({}).toString.call(g).slice(8,-1)},each:function(j,m){var h,k=0,g=j.length,l=g===c&&({}).toString.call(j).slice(8,-1)==="Object";if(l){for(h in j){if(m.call(j[h],h,j[h])===false){break}}}else{for(;k<g;){if(m.call(j[k],k,j[k++])===false){break}}}},toArray:function(g){return e.slice.call(g)},getHtmlElement:function(h){var g=a;g.element||(g.element={});g.element[h]||(g.element[h]=f.createElement(h));return g.element[h].cloneNode(true)},getEvent:function(g){return g||b.event},getTarget:function(g){return g.srcElement||g.target},stopEvent:function(g){g.returnValue&&(g.returnValue=false,g.cancelBubble=false);g.preventDefault&&(g.preventDefault(),g.stopPropagation())},getViewportSize:function(){var g=[0,0];c!==b.innerWidth?g=[b.innerWidth,b.innerHeight]:g=[document.documentElement.clientWidth,document.documentElement.clientHeight];return g},getClinetRect:function(g){var i=g.getBoundingClientRect(),h=(h={left:i.left,right:i.right,top:i.top,bottom:i.bottom,height:(i.height?i.height:(i.bottom-i.top)),width:(i.width?i.width:(i.right-i.left))});return h},getScrollPosition:function(){var g=[0,0];if(b.pageYOffset){g=[b.pageXOffset,b.pageYOffset]}else{if(typeof document.documentElement.scrollTop!="undefined"&&document.documentElement.scrollTop>0){g=[document.documentElement.scrollLeft,document.documentElement.scrollTop]}else{if(typeof document.body.scrollTop!="undefined"){g=[document.body.scrollLeft,document.body.scrollTop]}}}return g},addEvent:function(k,j,i,h){var g=arguments.callee;k.attachEvent&&(g=function(n,m,l){n.attachEvent("on"+m,l)}).apply(this,arguments);k.addEventListener&&(g=function(n,m,l){n.addEventListener(m,l,h||false)}).apply(this,arguments);k["on"+j]&&(g=function(n,m,l){n["on"+m]=function(){l()}}).apply(this,arguments)},removeEvent:function(k,j,i,h){var g=arguments.callee;k.detachEvent&&(g=function(n,m,l){n.detachEvent("on"+m,l)}).apply(this,arguments);k.removeEventListener&&(g=function(n,m,l){n.removeEventListener(m,l,h||false)}).apply(this,arguments);k["on"+j]&&(g=function(n,m,l){n["on"+m]=null}).apply(this,arguments)},currentStyle:function(g,h){return c!==g.currentStyle?g.currentStyle[h]:document.defaultView.getComputedStyle(g,null)[h]},getClipboardText:function(h){h=this.getEvent(h);var g=h.clipboardData;return g.getData("text")},setClipboardText:function(l,j){l=this.getEvent(l);try{b.clipboardData.setData("text",j)}catch(l){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var h=Components.classes["@mozilla.org/widget/clipboard;1"].createInstance(Components.interfaces.nsIClipboard);var g=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);g.addDataFlavor("text/unicode");var k=Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);k.data=j;g.setTransferData("text/unicode",k,j.length*2);var i=Components.interfaces.nsIClipboard;h.setData(g,null,i.kGlobalClipboard)}},domReady:(function(){var h=[],g=document;h.isReady=false;h.isFunction=function(i){return Object.prototype.toString.call(i)==="[object Function]"};h.Ready=function(i){h.initReady();if(h.isFunction(i)){if(h.isReady){i()}else{h.push(i)}}};h.fireReady=function(){if(h.isReady){return}h.isReady=true;for(var j=0,l=h.length;j<l;j++){var k=h[j];k()}h.length=0};h.initReady=function(){if(g.addEventListener){g.addEventListener("DOMContentLoaded",function(){g.removeEventListener("DOMContentLoaded",arguments.callee,false);h.fireReady()},false)}else{if(g.getElementById){g.write('<script id="ie-domReady" defer=\'defer\' src="//:"><\/script>');g.getElementById("ie-domReady").onreadystatechange=function(){if(this.readyState==="complete"){h.fireReady();this.onreadystatechange=null;this.parentNode.removeChild(this)}}}}};return h.Ready})(),dynamicScriptProxy:function(g,j,p){var m=document,l=m.createElement("script"),k=+(new Date()),q="abcdefghijk",n=Math.random().toFixed(1)*10,o=q[n]+k;g+=g.indexOf("?")>0?"":"?";for(var h in j){g+=h+"="+j[h]+"&"}g+="jsoncallback="+o+"&";g+="timestamp="+k;if(typeof p=="function"){b[o]=function(){try{p.apply(this,arguments)}catch(r){throw new Error(r)}finally{b[o]=null;if(l.attributes.length>0){for(var i in l){try{l.removeAttribute(l[i])}catch(r){}}}if(l&&l.parentNode){l.parentNode.removeChild(l)}}}}l.setAttribute("type","text/javascript");l.setAttribute("src",g);m.getElementsByTagName("head")[0].appendChild(l)},trigger:function(i,h){var g,j=document;c!==j.createEvent?(g=j.createEvent("MouseEvents"),g.initMouseEvent(h,true,true,document.defaultView,0,0,0,0,0,false,false,false,false,0,null),i.dispatchEvent(g)):(g=j.createEventObject(),g.screenX=100,g.screenY=0,g.clientX=0,g.clientY=0,g.ctrlKey=false,g.altKey=false,g.shiftKey=false,g.button=false,i.fireEvent("on"+h,g))},duffsDevice:function(g,j){if("function"!==typeof(j)){return}var k=g.length%8,h=g.length-1,l=j;while(k){l(g[h--]);k--}k=Math.floor(g.length/8);while(k){l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);l(h--,g[h]);k--}}};if(b===this||"indicator" in this){return new d}}();imageMagic.tk||(imageMagic.tk=a)}(window);
delete function(b,c){var a=function(h){var d=arguments.callee,i=document,e=imageMagic.tk,g=this,f=6,j=null;h=h||i.getElementsByTagName("body")[0];if(!g instanceof d){return new d(h)}j={TL:{css:"top:0;left:0;cursor:nw-resize",size:function(k){j.CL.size(k);j.TC.size(k)}},TC:{css:"top:0;left:48%;cursor:n-resize",size:function(k){g.correctY(g.hanlderInfo._down-k.clientY,g.hanlderInfo._mxTH);g.correctTop()}},TR:{css:"right:0;top:0;cursor:ne-resize",size:function(k){j.CR.size(k);j.TC.size(k)}},CL:{css:"top:48%;left:0;cursor:w-resize",size:function(k){g.correctX(g.hanlderInfo._right-k.clientX,g.hanlderInfo._mxLW);g.correctLeft()}},CR:{css:"top:48%;right:0px;cursor:e-resize",size:function(k){g.correctX(k.clientX-g.hanlderInfo._left,g.hanlderInfo._mxRW)}},BL:{css:"bottom:0;left:0;cursor:sw-resize",size:function(k){j.CL.size(k);j.BC.size(k)}},BC:{css:"bottom:0;left:48%;cursor:s-resize",size:function(k){g.correctY(k.clientY-g.hanlderInfo._top,g.hanlderInfo._mxDH)}},BR:{css:"bottom:0;right:0px;cursor:se-resize",size:function(k){j.CR.size(k);j.BC.size(k)}}};g.area=null;g.activity||(d.prototype.constructor=d),d.fn=d.prototype,d.fn.constructor=d;d.fn.activity=function(l,o){var n=null,k=[];typeof o==="function"&&(g.fn=o);g.data&&(g.Data=null);if(null===g.area){g.info=e.getHtmlElement("span");g.area=e.getHtmlElement("div");g.area.style.visibility="hidden";g.area.id="clipArea";g.area.appendChild(g.info);h.appendChild(g.area);k=["TL","TC","TR","CL","CR","BL","BC","BR"];e.each(Array(8),function(q,p){n=e.getHtmlElement("b");n.id=k[q];n.fn=j[k[q]];e.addEvent(n,"mousedown",g.mousemoveCheckThreshold,false);e.addEvent(n,"touch",g.mousemoveCheckThreshold,false);g.area.appendChild(n);g.setHanldPosition(n,g.area,k[q])});e.addEvent(g.area,"mousedown",g.mousemoveCheckThreshold,false);g.area.style.visibility="visible"}g.setProp(+l.width,+l.height);var m=g.area.parentNode;g.area.style.cssText="width:"+l.width+"px;height:"+l.height+"px;top:"+m.scrollTop+"px;left:"+m.scrollLeft+"px"};d.fn.setHanldPosition=function(r,k,q){var l=k.offsetWidth,t=k.offsetHeight,n=(l-f),m=Math.floor((l-f)/2),s=(t-f),o=Math.floor((l-f)/2);r.style.cssText=j[q].css};d.fn.mousemoveCheckThreshold=function(m){m=e.getEvent(m);var l=e.getTarget(m),n=[],k=m.type;while(l&&l.nodeType!==1){l=l.parentNode}({mousedown:function(o){o=e.getEvent(o);e.stopEvent(o);i.currentTarget=l;g.pos=e.getClinetRect(l);g.origin=[o.clientX-g.pos.left,o.clientY-g.pos.top];l.nodeName.toLowerCase()==="b"&&g.checkHandler(o);e.addEvent(i,"mouseup",g.mousemoveCheckThreshold,false);e.addEvent(i,"mousemove",g.mousemoveCheckThreshold,false)},mousemove:function(p){p=e.getEvent(p);var o=i.currentTarget,q={top:p.clientX,right:p.clientY+o.offsetWidth,down:p.clientX+o.offsetHeight,left:p.clientY};o.nodeName.toLowerCase()==="b"?g.handlerMove.call(o,p,q):g.areaMove.call(o,p,q);e.stopEvent(p)},mouseup:function(p){p=e.getEvent(p);var o=e.getTarget(p);if(o.nodeName.toLowerCase()!=="b"){try{o.style.cursor="move"}catch(p){}}e.removeEvent(i,"mousemove",g.mousemoveCheckThreshold,false);e.removeEvent(i,"mouseup",g.mousemoveCheckThreshold,false);g.pos=g.origin=null;delete g.hanlderInfo;e.stopEvent(p)}})[m.type](m)};d.fn.checkHandler=function(n){n=e.getEvent(n);var m=e.getTarget(n),k=m.parentNode,l=e.getClinetRect(k);g.hanlderInfo||(g.hanlderInfo={});g.hanlderInfo.mxT=0;g.hanlderInfo.mxL=0;g.hanlderInfo.mxR=k.parentNode.clientWidth+k.parentNode.scrollLeft-2;g.hanlderInfo.mxB=k.parentNode.clientHeight+k.parentNode.scrollTop-2;g.hanlderInfo.mxR=Math.max(g.hanlderInfo.mxR,g.hanlderInfo.mxL+40);g.hanlderInfo.mxB=Math.max(g.hanlderInfo.mxB,g.hanlderInfo.mxT+40);g.hanlderInfo.width=k.clientWidth;g.hanlderInfo.height=k.clientHeight;g.hanlderInfo.left=k.offsetLeft;g.hanlderInfo.top=k.offsetTop;g.hanlderInfo._left=l.left;g.hanlderInfo._right=l.right;g.hanlderInfo._top=l.top;g.hanlderInfo._down=l.bottom;g.hanlderInfo._fixLeft=g.hanlderInfo.width+g.hanlderInfo.left;g.hanlderInfo._fixTop=g.hanlderInfo.height+g.hanlderInfo.top;g.hanlderInfo._mxRW=g.hanlderInfo.mxR-g.hanlderInfo.left;g.hanlderInfo._mxDH=g.hanlderInfo.mxB-g.hanlderInfo.top;g.hanlderInfo._mxTH=Math.max(g.hanlderInfo._fixTop-g.hanlderInfo.mxT,0);g.hanlderInfo._mxLW=Math.max(g.hanlderInfo._fixLeft-g.hanlderInfo.mxL,0)};d.fn.correctX=function(k,l){k=g.correctWidth(k,l);g.hanlderInfo.width=k};d.fn.correctY=function(k,l){k=g.correctHeight(k,l);g.hanlderInfo.height=k};d.fn.correctWidth=function(k,l){k=Math.min(l,k);k=Math.max(k,40,0);return k};d.fn.correctHeight=function(k,l){k=Math.min(l,k);k=Math.max(k,40,0);return k};d.fn.correctTop=function(){g.hanlderInfo.top=g.hanlderInfo._fixTop-g.hanlderInfo.height};d.fn.correctLeft=function(){g.hanlderInfo.left=g.hanlderInfo._fixLeft-g.hanlderInfo.width};d.fn.handlerMove=function(k){k=e.getEvent(k);var l=this.id;this.fn.size(k);g.resize();e.stopEvent(k)};d.fn.resize=function(k){var l=g.area;l.style.cssText="width:"+g.hanlderInfo.width+"px;height:"+g.hanlderInfo.height+"px;top:"+(g.hanlderInfo.top+1)+"px;left:"+(g.hanlderInfo.left+1)+"px";g.fn&&g.fn();g.setProp(g.hanlderInfo.width,g.hanlderInfo.height)},d.fn.areaMove=function(p){var q=[p.clientX,p.clientY],o=this.parentNode,k=[o.scrollWidth,o.scrollHeight],n=e.getClinetRect(this.parentNode),l,m;this.style.cursor="crosshair";l=Math.max(q[0]-n.left+o.scrollLeft-g.origin[0],0);l=Math.min(l,k[0]-this.offsetWidth);this.style.left=l+"px";m=Math.max(q[1]-n.top+o.scrollTop-g.origin[1],0);m=Math.min(m,k[1]-this.offsetHeight);this.style.top=m+"px"};d.fn.removeArea=function(k){try{g.area.parentNode.removeChild(g.area),g.area=null}catch(l){}finally{("function"===typeof k)&&k()}};d.fn.getData=function(){try{return[g.area.offsetLeft,g.area.offsetTop,g.area.offsetWidth,g.area.offsetHeight]}catch(k){}};d.fn.setProp=function(l,k){g.info.innerHTML="\u5bbd:"+Math.ceil(l)+"px&nbsp;&nbsp;\u9ad8:"+Math.ceil(k)+"px&nbsp;&nbsp;\u6bd4\u4f8b:"+g.proportion(l,k)};d.fn.proportion=function(k,m){k=k.toPrecision(1),m=m.toPrecision(1);var l=((k<m)?k:m);while(true){if(k%l==0&&m%l==0){break}l--}return(Math.abs(k/l)+":"+Math.abs(m/l))}};imageMagic.tk.domReady(function(){imageMagic.clip||(imageMagic.clip=new a(document.getElementById(imageMagic.config.canvasContainer)))})}(window);
delete function(b,c){function a(j,i,h){var g=this,d=arguments.callee,e=null,f=null;if(!(g instanceof d)){return new d(j,i,h)}f={O:g.o=j,P:g.property=i,T:g.t=h.t||0,C:g.c=h.c||50,D:g.d=h.d||100,R:g.r=h.r||false};"function"===typeof(h.callback)&&(f.fn=h.callback);if(1!==f.O.nodeType){return false}c===this.Tween&&(d.prototype.Tween=function(){return g.Bounce.apply(g,arguments)});d.prototype.constructor=d;d.prototype.Bounce=function(l,k,n,m){return n*l/m+k};d.prototype.fx=function(m,k,o,n){var l=Math.ceil(g.Tween.apply(g,arguments));if(l>g.c){return false}return(true===f.R?(-l):(l))+e};d.prototype.play=function(o,n){var m=f.T,k=0,l=false;e=parseInt(g.currentStyle(j,i));void function(){var p=g.fx(m,k,f.C,f.D);o.style[n]=p+"px";Math.abs(p)<f.C+e?(m++,setTimeout(arguments.callee,13)):l=true;(true===l&&c!==f.fn)&&(setTimeout(function(){f.fn.call(g)},300))}()};d.prototype.currentStyle=function(l,m){var k=null;return c!==l.currentStyle?l.currentStyle[m]:document.defaultView.getComputedStyle(l,null)[m]};g.play.call(g,f.O,f.P)}a.doFade=function(j,k,g,i){var d=c!==b.ActiveXObject,m=arguments.callee,l=this,f;k+=(g?1:-1)/j,(g?k>1:k<0)&&(k=g?1:0);try{l.style.opacity=k}catch(h){l.style.filter="alpha(opacity="+k*100+")"}(g?k<1:k>0)&&setTimeout(function(){m.call(l,j,k,g,i)},1000/j);(g?k===1:k===0&&"undefined"!==typeof i)&&("function"===typeof i&&i.call(l))};a.fadeOut=function(d,e){a.doFade.call(this,d/10,1,false,e)};a.fadeIn=function(d,e){a.doFade.call(this,d/10,0,true,e)};imageMagic.animate||(imageMagic.animate=a)}(window);
delete function(){function a(f){var i=this,h=document,j=arguments.callee;if(!(this instanceof arguments.callee)){return new arguments.callee(f)}i.wrapper=f.wrapper;i.handler=f.handler||"h3";i.container=f.container||"div";i.current=f.current||"current";i.action=false;var b=h.getElementById(i.wrapper),l=b.getElementsByTagName(i.handler),c=b.getElementsByTagName(i.container),k=g(l,b),e=g(c,b);if(!d()){return}function d(){if(!b){return false}if(!(k.length==e.length)){return false}return true}function g(u,r){var q=0,m=u.length,n=0,s=[];for(;q<m;){u[q].parentNode==r&&(++n,s.push(u[q]));q++}return{length:n,obt:s}}j.prototype.constructor=j.name;(typeof i.each!="function")&&(j.prototype.each=function(s,r){var q=0,p,m=s.length,n=this||window;if(m===undefined){for(p in s){if(r.call(n,p,s[p])===false){break}}}else{for(;q<m&&r.call(n,q,s[q])!==false;++q){}}return s});j.prototype.Linear=function(n,m,p,o){return p*n/o+m};j.prototype.fx=function(r){var m=0,s=i.getHeight(r),q=5,p=0,n=0;~function(){r.style.height=Math.ceil(i.Linear(p,m,s,q))+"px";if(parseInt(r.style.height)<s){p++;setTimeout(arguments.callee,5)}if(n<100){n++;i.fade.call(r,Math.ceil(i.Linear(n,m,100,q)))}}()};j.prototype.fade=function(m){this.style.filter="alpha(opacity="+m+")";this.style.opacity=m/100};j.prototype.getHeight=function(n){var m=0;n.style.visiblity="hidden";m=n.scrollHeight;n.style.visiblity="hidden";return m};j.prototype.release=function(){i.each(e.obt,function(n,m){m.style.cssText="display:none"})};j.prototype.init=function(){i.release();i.each(k.obt,function(n,m){i.play(m)})};j.prototype.currentStyle=function(n,o){var m=null;return undefined!==n.currentStyle?n.currentStyle[o]:document.defaultView.getComputedStyle(n,null)[o]};j.prototype.play=function(n){var m=this;i.addEvent(n,"click",function(s){s=window.event||s;var q=s.srcElement||s.target,p=i.index(q,k.obt),r=e.obt[p];var o=m.currentStyle(r,"display");i.each(l,function(t,u){if(t!==p){u.removeAttribute("class")}});n.className=i.current;i.release();r.style.display=o==="block"?"none":"block"},false)};j.prototype.index=function(n,m){var o=-1;i.each(m,function(p,q){n===q&&(o=p)});return o};j.prototype.addEvent=function(p,o,n,m){if(p.addEventListener){p.addEventListener(o,n,m)}else{if(p.attachEvent){p["e"+o+n]=n;p[o+n]=function(){p["e"+o+n](window.event)};p.attachEvent("on"+o,function(){n.call(p)})}else{p["on"+o]=n}}};return{init:function(){i.init()}}}imageMagic.accordion||(imageMagic.accordion=a)}();
delete function(b,c){var a=function(){};a.prototype={request:function(i,u){var d=(i.method).toUpperCase(),e=i.url,s=i.callback,h=i.postVars||null,j=i.timeout||0,g=i.async||true,t=this,f;t.ajax=t.createXhr(),t.ajax.onreadystatechange=function(){switch(t.ajax.readyState){case 1:if(j){f=setTimeout(function(){if(t.ajax.readyStat==1){t.ajax.abort()}},j);clearTimeout(f)}s.loading?s.loading.call(this,f):null;break;case 2:s.loaded?s.loaded.call(this,f):null;break;case 3:s.interactive?s.interactive.call(this,f):null;break;case 4:/200|304/.test(t.ajax.status)?s.success(t.ajax.responseText,t.ajax.responseXML):{};break}};t.ajax.open(d,e,g);if(d!=="POST"){h=null}t.ajax.setRequestHeader("Content-type","application/x-www-form-urlencoded;");t.ajax.send(h);typeof u==="function"&&u()},abortAjax:function(){this.ajax.abort()},createXhr:function(){var i=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Mircosoft.XMLHTTP")}];for(var j=0,d=i.length;j<d;j++){try{i[j]()}catch(k){continue}this.createXhr=i;return i[j]()}throw new Error("This browser could not create Ajax Object")},getJson:function(d){this.temp=new a();this.temp.request(d);return parse=function(e){if(!/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){return null}return b.JSON&&b.JSON.parse?b.JSON.parse(e):(new Function("return "+e))()}}};imageMagic.tk.ajax||(imageMagic.tk.ajax=a)}(window);
delete function(b,c){function a(e,h){if(!(this instanceof arguments.callee)){return new arguments.callee(e,h)}var k,j,f,d,i,l,g;(j=document,f=this,g=imageMagic,l=g.tk,i=g.root,d=j.createDocumentFragment(),k=arguments.callee);e||(e={});f.html=e.html;f.titleTxt=e.title||"\u6807\u9898";f.buttonText=e.btn||" \u786e\u5b9a ";f.hasMask=e.hasMask||true;f.hasCancel=e.cancel||true;f.cancelTxt=e.cancelTxt||" X ";f.width=e.width||400;f.height=e.height||300;f.hasAnimate=e.animate||false;f.name=e.name||"";f.maskColor=e.maskColor||"black";f.maskDepth=e.maskDepth||50;f.dialogBg=e.dialogBg||"white";f.zIndex=Math.floor(999+Math.random()*9000);f.viewPort=l.getViewportSize();f.scollPos=l.getScrollPosition();f.maxSize=[f.viewPort[0]+f.scollPos[0],f.viewPort[1]+f.scollPos[1]];typeof h==="function"&&(f.fn=h);f.mask=f.title=f.titleCon=f.cancel=f.container=null;k.fn=k.prototype;k.fn.constructor=k;k.fn.init=function(){f.htmlFactory();f.hasMask&&f.createMask();f.createDailog();f.addEvent()};k.fn.htmlFactory=function(){f.mask=l.getHtmlElement("div");f.dailog=l.getHtmlElement("div");f.title=l.getHtmlElement("h3");f.titleCon=l.getHtmlElement("span");f.cancel=l.getHtmlElement("b");f.container=l.getHtmlElement("div")};k.fn.createMask=function(){i.appendChild(f.mask);f.mask.style.cssText="position:absolute;z-index:"+f.zIndex+";background-color:"+f.maskColor+";opacity:"+f.maskDepth/100+";width:100%;height:"+f.maxSize[1]+"px;top:0;left:0;"};k.fn.createDailog=function(){f.titleCon.appendChild(j.createTextNode(f.titleTxt));f.title.appendChild(f.titleCon);f.cancel.appendChild(j.createTextNode(f.cancelTxt));f.cancel.style.cssText="position:absolute;right:10px;cursor:pointer";f.title.appendChild(f.cancel);f.container.appendChild(f.title);f.name&&(f.container.id="dailogContainer-"+f.name);f.container.className="dailogContainer";f.dailog.appendChild(f.title);f.dailog.style.cssText="position:absolute;z-index:"+(f.zIndex+1)+";width:"+f.width+"px;height:"+f.height+"px;left:"+(f.viewPort[0]-f.width)/2+"px;top:"+((f.viewPort[1]-f.height)/2+f.scollPos[1])+"px;background-color:"+f.dialogBg;f.name&&(f.dailog.id="dailog-"+f.name);f.dailog.className="dailog";f.dailog.appendChild(f.container);f.hasAnimate&&(f.dailog.style.opacity=0,g.animate.fadeIn.call(f.dailog,80));d.appendChild(f.dailog);i.appendChild(d);f.html&&(f.container.innerHTML=f.html);f.fn&&(f.fn.call(f))};k.fn.removeDailog=function(){try{f.hasAnimate&&(g.animate.fadeOut.call(f.dailog,20,function(){delete f.dailog.parentNode.removeChild(f.dailog)}));f.dailog.parentNode.removeChild(f.dailog)}catch(m){}try{f.mask.parentNode.removeChild(f.mask)}catch(m){}f.dailog=f.mask=null};k.fn.addEvent=function(){l.addEvent(f.cancel,"click",function(){f.removeDailog()},false)};f.init()}imageMagic.dailog||(imageMagic.dailog=a)}(window);

void function(window,undefined){var WorkSpace;WorkSpace=function(){var indicator=arguments.callee,doc=document,that=this,usedWidth=0,usedHeight=0,workWidth=0,workHeight=0,IM=imageMagic,tk=IM.tk,IMC=IM.config,IMW=IMC.workSpace;if(!that instanceof indicator){return new indicator()}IM.editing||(IM.editing=false);indicator.fn=indicator.prototype;indicator.fn.constructor=indicator;indicator.fn.workSpaceControl=function(){var op={toolbar:doc.getElementById(IMC.toolbar),leftSidebar:doc.getElementById(IMC.leftSidebar),canvasContainer:doc.getElementById(IMC.canvasContainer),importImage:doc.getElementById(IMC.importImage),gallery:doc.getElementById(IMC.gallery),imageList:doc.getElementById(IMC.imageList),galleryTitle:doc.getElementById(IMC.galleryTitle),imageLoader:doc.getElementById(IMC.imageLoader.id),viewPort:IM.tk.getViewportSize()};usedWidth=doc.getElementById(IMC.leftSidebar).offsetWidth;usedHeight=doc.getElementById(IMC.toolbar).offsetHeight;workWidth=op.viewPort[0]-parseInt(usedWidth,10)-20;workHeight=op.viewPort[1]-parseInt(usedHeight,10)-10;op.canvasContainer.style.width=op.gallery.style.width=workWidth+"px";op.canvasContainer.style.height=op.gallery.style.height=workHeight+"px";op.imageLoader.style.height=op.viewPort[1]+"px";op.imageList.style.height=op.gallery.offsetHeight-op.galleryTitle.offsetHeight-30+"px";op.leftSidebar.style.height=op.importImage.style.height=workHeight+"px";IM.availSize||(IM.availSize=null);IM.availSize=[workWidth,workHeight]};indicator.fn.canvasControl=function(){IM.canvas=tk.getHtmlElement("canvas")};indicator.fn.workInit=function(){var that=this,btn=doc.getElementById(IMC.imageLoader.btn);that.imageListLength=0;that.photosId=[];that.form=doc.getElementById("imageForm");that.imageList=doc.getElementById(IMC.imageList);that.galleryTitle=doc.getElementById(IMC.galleryTitle);that.galleryMassage=doc.getElementById(IMC.galleryMassage);that.web=doc.getElementById(IMC.imageLoader.web);that.natives=doc.getElementById(IMC.imageLoader.natives);that.loader=doc.getElementById(IMC.imageLoader.loader);that.revoke=doc.getElementById(IMC.revoke);that.Enter=doc.getElementById(IMC.Enter);that.index=0;that.number=0;try{that.reader=new FileReader()}catch(e){}that.titleName=[];that.html||(that.html=[]);IM.currentEdit||(IM.currentEdit=-1);IM.animate.fadeIn.call(that.galleryTitle,20);try{new FileReader().readAsDataURL}catch(e){that.natives.parentNode.style.display="none"}IM.tk.addEvent(that.revoke,"click",function(){IM.workSpace.imageInstall(IM.sourceImg)});IM.tk.addEvent(that.Enter,"click",function(){var temp=IMW.control,handler=doc.getElementById(temp.id).getElementsByTagName(temp.tag);IM.clip.area&&IM._clip.removeArea();try{IM._scale.destroy()}catch(e){}try{IM.markPreview.parentNode.removeChild(IM.markPreview)}catch(e){}IM.currentEdit==-1||(that.Enter.disabled="disabled",that.outputImage.call(that));IM.tk.each(handler,function(a,b){var temp=b.nextSibling;while(temp.nodeType===3){temp=temp.nextSibling}temp.style.display="none"});return false},false)};indicator.fn.imageLoader=function(){var viewPort=IM.tk.getViewportSize(),switchs=that.galleryTitle.getElementsByTagName("input");IMC.imageLoader.loader=doc.getElementById(IMC.imageLoader.id);IMC.imageLoader.loader.style.height=viewPort[1]+"px";IMC.imageLoader.loader.style.display="block";IM.tk.each(switchs,function(a,b){b.type==="button"&&(IM.tk.addEvent(b,"click",function(){that.switchsListener(that,b)},false))});IM.tk.addEvent(that.web,"blur",function(){var reg=IMC.imageLoader.reg.web,value=this.value.trim();reg.test(value)&&(that.web.disabled="disabled",that.loader&&(that.loader.style.display="inline-block"),that.imageWebSrc(value));this.value=this.defaultValue},false);IM.tk.addEvent(that.web,"focus",function(){this.value==this.defaultValue&&(this.value="")},false);IM.tk.addEvent(that.natives,"change",function(){var value=this.value,reg=IMC.imageLoader.reg.natives;that.imageNativeSrc(this),this.value=""},false)};indicator.fn.outputImage=function(){var that=this,temp=IMC.imageLoader.loader,imageData=null,number=IM.currentEdit;try{imageData=IM.canvas.toDataURL("image/jpeg");IM.images[number].src=imageData}catch(e){}setTimeout(function(){try{temp.style.display="block"}catch(e){}that.Enter.removeAttribute("disabled");IM.canvas.width=0;IM.canvas.height=0},200)};indicator.fn.addImageListImgEvent=function(){var that=this,images=that.imageList.getElementsByTagName("img"),i=images.length;IM.images||(IM.images=images);IM.tk.each(images,function(a,b){void function(i){IM.tk.addEvent(b,"dblclick",function(e){IM.currentEdit=i;that.imageInstall(b.src,function(){var temp=IMC.imageLoader.loader;temp.style.display="none"});IM.tk.stopEvent(e)},false);IM.tk.addEvent(b,"tocuchstart",function(e){},false)}(a)})};indicator.fn.addImageListCheckboxEvent=function(){var inputs=that.imageList.getElementsByTagName("input");IM.tk.each(inputs,function(a,b){if(b.type==="button"){b.onclick=function(){this.className==="del"&&(that.removeImageItem(this));return false}}})};indicator.fn.switchsListener=function(that,elem){({galleryAll:function(){that.checkboxControl(that,1)},galleryReverse:function(){that.checkboxControl(that,-1)},galleryDelete:function(){that.checkboxControl(that,0)},galleryPost:function(){var inputs=that.imageList.getElementsByTagName("input"),tempdata=that.getAllData(inputs),tips,dailog;if(tempdata.length===0){tips=IM.dailog({name:"uploadTips",title:"\u63d0\u793a",html:"<p><b>\u8bf7\u9009\u62e9\u8981\u4e0a\u4f20\u7684\u56fe\u7247\uff01</b></p><p>2\u79d2\u540e\u81ea\u52a8\u5173\u95ed</p>",width:300,height:100},function(){setTimeout(function(){tips.removeDailog()},2000)});return false}var ajax=new IM.tk.ajax(),temp=IM.config.dataURL.postImage,searchs=location.search.replace(/\?/g,""),data=searchs+"&imgdata="+tempdata.join(""),cancelUpload=function(d){ajax.abortAjax();d.removeDailog()},callback={success:function(a,b){var temp=eval("("+a+")");({ok:function(){dailog.container.innerHTML="<p><b>\u9009\u4e2d\u56fe\u7247\u5df2\u4e0a\u4f20\u5b8c\u6210\uff01</b></p>";setTimeout(function(){dailog.removeDailog()},1000);if(temp.photoids){that.photosId.push(temp.photoids);that.shutData(inputs,function(){setTimeout(function(){that.imageListLength===0&&(location.href=(IMC.jumpURL.pic+location.search+"&batch="+that.photosId.join(",")))},2000)})}if(temp.imgurl){that.shutData(inputs,function(){setTimeout(function(){that.imageListLength===0&&(window.open(IMC.jumpURL.cms+"?data="+encodeURI(temp.imgurl)))},2000)})}},error:function(){alert("\u4e0a\u4f20\u5931\u8d25");dailog.removeDailog()}})[temp.status]()},failure:function(stauts){dailog.removeDailog();alert("ajax\u8bf7\u6c42\u5931\u8d25:"+stauts)}};ajax.request({method:"POST",url:temp.url,callback:callback,postVars:encodeURI(data)},function(){dailog=IM.dailog({name:"uploading",title:"\u4e0a\u4f20",html:'<p><b>\u6b63\u5728\u4e0a\u4f20,\u8bf7\u8010\u5fc3\u7b49\u5f85\uff01</b></p><p><input type="button" id="uploadImageCancel" value=" \u53d6\u6d88 " /> </p>',width:300,height:100},function(){var btn=doc.getElementById("uploadImageCancel"),that=this,parent=that.cancel.parentNode,rmbtn=null,cancelBtn=null;try{rmbtn=parent.removeChild(that.cancel)}catch(e){alert(e)}cancelBtn=rmbtn.cloneNode(true);parent.appendChild(cancelBtn);IM.tk.addEvent(cancelBtn,"click",function(){cancelUpload(that)},false);IM.tk.addEvent(btn,"click",function(){cancelUpload(that)},false)})})}})[elem.id]()};indicator.fn.shutData=function(inputs,fn){IM.tk.each(inputs,function(a,b){(b.type==="checkbox"&&b.checked===true)&&(that.removeImageItem(b))});typeof fn=="function"&&fn()};indicator.fn.getAllData=function(inputs){var html=[],temp=null;IM.tk.each(inputs,function(a,b){(b.type==="checkbox"&&b.checked===true)&&(temp=b.parentNode.previousSibling,html.push(temp.src+"!"+temp.title+"#"))});return html};indicator.fn.checkboxControl=function(that,flag){var checkbox=that.imageList.getElementsByTagName("input");IM.tk.each(checkbox,function(a,b){if(b.type==="checkbox"){that.checkeStatus.call(that,b,flag)}})};indicator.fn.checkeStatus=function(elem,flag){switch(flag){case 1:elem.checked="checked";break;case -1:elem.checked==true?elem.checked=false:elem.checked=true;break;case 0:if(elem.checked==true){this.removeImageItem(elem)}break}};indicator.fn.removeImageItem=function(elem){var parent=elem.parentNode;while(parent.tagName.toLowerCase()!=="dl"){parent=parent.parentNode}IM.animate(parent,"left",{c:parent.offsetWidth/2,d:5,r:true,callback:function(){try{parent.parentNode.removeChild(parent)}catch(e){}that.imageListLength--;that.galleryMassage.innerHTML="\u56fe\u7247\u603b\u6570\uff1a"+(that.imageListLength);that.imageListLength=that.imageListLength<0?Math.abs(that.imageListLength):that.imageListLength}});IM.animate.fadeOut.call(parent,50)};indicator.fn.fileAPIReader=function(file,length,index){var calls=arguments.callee,temp=function(e){that.createImageList(e.target.result,that.titleName[that.number]);that.number++;calls(file,length,index+1)};that.reader.onload=temp;that.reader.onerror=temp;that.setImageList();try{that.reader.readAsDataURL(file.shift())}catch(e){}};indicator.fn.imageNativeSrc=function(img){var srcs=img.files,that=this,arr=[],temp;IM.tk.each(srcs,function(a,b){if(b.size>IMC.imageLoader.dataSize){temp||(temp=IM.dailog({name:"imageSizeTip",title:"\u63d0\u793a",width:360,height:120}));temp.container.innerHTML+="<p>"+a+".\u56fe\u7247<b>"+b.name+"</b>\u5927\u5c0f\u8d85\u8fc7 "+IMC.imageLoader.dataSize/1024000+"M \u9650\u5236\uff0c\u6ca1\u6709\u5bfc\u5165\uff01</p>"}if(b.type==="image/jpeg"&&b.size<IMC.imageLoader.dataSize){arr.push(b);that.titleName.push(b.name)}});setTimeout(function(){that.fileAPIReader(arr,arr.length,0)},100)};indicator.fn.initWebLoader=function(){that.web.removeAttribute("disabled");that.loader&&(that.loader.style.display="none")};indicator.fn.imageWebSrc=function(src){var that=this,temp=IM.config.dataURL.proxyImage,param=temp.param;param.photourl=src;IM.tk.dynamicScriptProxy(temp.url,param,function(b){var data=b[0];data.status==="ok"&&(that.initWebLoader(),that.createImageList("data:image/jpeg;base64,"+data.imgdata,data.name),that.setImageList());data.status==="error"&&(alert("\u7f51\u7edc\u56fe\u7247\u8bfb\u53d6\u5931\u8d25"),that.initWebLoader())})};indicator.fn.setWebSrc=function(src,name){var that=this,img=doc.getElementById("images"+that.number),title=doc.getElementById("imagesTitle"+that.number);img.src=src;title.innerHTML=name;that.number++};indicator.fn.createImageList=function(data,name){var that=this,create=IM.tk.getHtmlElement,dl=create("dl"),dt=create("dt"),dd=create("dd"),img=create("img"),span=create("span"),inputA=create("input"),inputB=create("input"),dummy=doc.createDocumentFragment();inputA.type="checkbox";inputA.checked=true;inputB.type="button";inputB.className="del";inputB.value="\u5220";img.src=data;img.title=name;span.appendChild(inputA);span.appendChild(inputB);dt.appendChild(img);dt.appendChild(span);dd.nodeValue=name;dl.appendChild(dt);dl.appendChild(dd);dd.innerHTML=name;dummy.appendChild(dl);that.imageList.appendChild(dummy);that.imageListLength++;that.galleryMassage.innerHTML="\u56fe\u7247\u603b\u6570\uff1a"+that.imageListLength};indicator.fn.setImageList=function(){that.galleryMassage.innerHTML="\u56fe\u7247\u603b\u6570\uff1a"+that.imageListLength;that.imageListLength>0&&(that.addImageListCheckboxEvent(),that.addImageListImgEvent());that.imageList.style.height=IM.availSize[1]-that.galleryTitle.scrollHeight-30+"px";((that.imageList.scrollHeight>that.imageList.offsetHeight)||(that.imageList.scrollHeight>IM.availSize[1]))?that.imageList.style.overflowY="scroll":that.imageList.style.overflowY="hidden";that.html="";return false};indicator.fn.imageInstall=function(imgSrc,fn){var canvas=IM.canvas,cxt=canvas.getContext("2d");IM.img=new Image;IM.sourceImg="";tk.addEvent(IM.img,"load",function(){var canvasSize=[IM.img.width,IM.img.height];IM.maxSize=canvasSize;cxt.strokeStyle=cxt.createPattern(IM.img,"no-repeat");canvas.width=canvasSize[0],canvas.height=canvasSize[1];cxt.drawImage(IM.img,0,0,canvasSize[0],canvasSize[1]);typeof(fn)==="function"&&fn()},false);tk.addEvent(IM.img,"error",function(){alert("\u56fe\u7247\u8bfb\u53d6\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528Ctrl+F5")},false);IM.sourceImg=imgSrc;IM.img.src=imgSrc;doc.getElementById(IMC.canvasContainer).appendChild(canvas)};indicator.fn.getCanvas=function(){var canvas=doc.getElementById("canvas"),cxt;canvas.getContext&&(cxt=canvas.getContext("2d"));return cxt};indicator.fn.clearCanvas=function(){var canvas=doc.getElementById("canvas"),cxt=canvas.getContext("2d");cxt.clearRect(0,0,IM.availSize[0],IM.availSize[1])};indicator.fn.availableNumberInput=function(inputs){var len=inputs.length,i,reg=/^(8|9|4[8-9]|5[0-7]|9[6-9]|10[0-5])$/ig;doc.onmousedown=function(){try{document.selection.empty()}catch(e){getSelection().removeAllRanges()}};for(i=len;i>0;(inputs[--i].onkeydown=function(e){e=window.event||e;var target=e.srcElement||e.target,code=e.charCode||e.keyCode;reg.lastIndex=0;if(!reg.test(code)||e.shiftKey){return false}target.value==="0"&&(target.value="")},inputs[i].oncontextmenu=function(){return false}),inputs[i].style.imeMode="disabled"){}};indicator.fn.init=function(){var temp=IMW.control,handler=doc.getElementById(temp.id).getElementsByTagName(temp.tag),i=handler.length,inputs=doc.getElementById(IMC.leftSidebar).getElementsByTagName("input");this.availableNumberInput(inputs);tk.each(handler,function(a,b){tk.addEvent(b,"click",function(){var canvas=IM.canvas,cxt=canvas.getContext("2d");IM.editing=b.id.replace(/IM/g,"");(cxt&&this.id!==undefined)&&IM[this.id.toString().replace(/IM/,"")].init()},false)})};indicator.fn.destroy=function(){var temp=IMW,handler=temp.button;tk.each(handler,function(a,b){var B=doc.getElementById(b);tk.addEvent(B,"click",function(e){e=IM.tk.getEvent(e);var target=IM.tk.getTarget(e);IM[this.id.replace(/Button/,"")].destroy();target.disabled="true";target.value=" \u5df2\u5e94\u7528 ";target.className="highlight"},false);tk.addEvent(b,"focus",function(){this.blur()},false)})};indicator.fn.buttonReset=function(elem){elem.value=elem.title,elem.removeAttribute("style"),elem.className="",elem.removeAttribute("disabled")};IM._clip={init:function(){try{IM.clip.area&&IM._clip.removeArea()}catch(e){}var that=IM._clip,canvas=IM.canvas,cxt=IM.canvas.getContext("2d");that.canvas=canvas;that.button=doc.getElementById("Button"+IM.editing);that.defaultValue.call(that);that.clientValue();that.w.value=IMC.areaSize[0];that.h.value=IMC.areaSize[1];that.select=doc.getElementById(IMW.clipDeafult);that.radioA=doc.getElementById("clipRadioDefault");that.radioB=doc.getElementById("clipRadioClient");that.addSize=doc.getElementById(IMW.addSize);IM.img.src=canvas.toDataURL("image/jpeg");that.areaCut(IMC.areaSize[0],IMC.areaSize[1]);that.select.options[0].selected="selected";IM.tk.addEvent(that.w,"change",function(){that.restButton()},false);IM.tk.addEvent(that.h,"change",function(){that.restButton()},false);that.restButton();IM.tk.addEvent(that.addSize,"click",that.addAreaSize,false);IM.tk.addEvent(that.radioA,"click",that.areaSet,false);IM.tk.addEvent(that.radioB,"click",that.areaSet,false);IM.tk.trigger(that.radioA,"click")},restButton:function(){IM.workSpace.buttonReset(this.button)},uploadImg:function(){var canvas=IM.canvas,cxt=canvas.getContext("2d"),newImg,temp=IM.clip.getData(),x,y,w,h;IM.step||(IM.step=0);tk.is(temp)==="Array"&&(x=Math.max(temp[0],0),y=Math.max(temp[1],0),w=Math.min(temp[2]-2,IM.maxSize[0]-x),h=Math.min(temp[3]-2,IM.maxSize[1]-y));if(w>0&&h>0){try{newImg=cxt.getImageData(x,y,w,h),canvas.width=w,canvas.height=h}catch(e){}}try{cxt.putImageData(newImg,0,0)}catch(e){}},addAreaSize:function(){var ajax=new IM.tk.ajax(),callback={},that=IM._clip,url=IM.config.dataURL.clientAreaSize.url;ajax.request({method:"POST",url:url,callback:callback,postVars:"dimen="+(that.w.value+"*"+that.h.value)},function(){alert("\u6536\u85cf\u6210\u529f")})},updataSelect:function(){var that=IM._clip,temp=IM.config.dataURL.clipSize;IM.tk.dynamicScriptProxy(temp.url,temp.param,function(b){that.select.length=0;that.select[0]=new Option("---\u8bf7\u9009\u62e9---");that.select.options[0].disabled="true";IM.tk.each(b,function(x,y){select.options[x+1]=new Option(y)});that.select.options[0].selected="selected"})},areaCut:function(x,y){var that=IM._clip,area=IM.clip.area,clipBtn=doc.getElementById(IMW.button[0]);IM.clip.activity({width:x,height:y},function(){that.w.value=IM.clip.area.clientWidth;that.h.value=IM.clip.area.clientHeight});IM.tk.addEvent(IM.clip.area,"dblclick",function(){that.getImage();that.removeArea();IM.tk.trigger(that.button,"click")},false);IM.tk.addEvent(clipBtn,"click",function(){that.finishClip(clipBtn);return false},false);IM.tk.addEvent(document,"keypress",this.keybordCut,false)},areaSet:function(e){e=IM.tk.getEvent(e);var that=IM._clip,target=IM.tk.getTarget(e);({clipRadioDefault:function(){that.w.disabled=true;that.h.disabled=true;that.select.disabled=false},clipRadioClient:function(){that.w.disabled=false;that.h.disabled=false;that.select.disabled=true}})[target.id]()},keybordCut:function(e){e=tk.getEvent(e);var keyCode=e.keyCode||e.charCode,target=IM.tk.getTarget(e);if(keyCode===13){IM._clip.finishClip(e.target)}return false},getImage:function(){try{IM._clip.uploadImg();IM.clip.area.style.left="0px",IM.clip.area.style.top="0px"}catch(e){}},removeArea:function(fn){IM.clip.removeArea(fn)},defaultValue:function(){var node=doc.getElementById("clipDeafult"),radio=doc.getElementById("clipRadioDefault"),value=null,that=this;IM.tk.addEvent(node,"change",function(){value=node.value.split("*"),IM._clip.areaCut(value[0],value[1]);that.restButton()},false)},clientValue:function(){var that=IM._clip,radio=doc.getElementById("clipRadioClient");that.w=doc.getElementById("clipClientWidth"),that.h=doc.getElementById("clipClientHeight");IM.tk.addEvent(that.w,"keyup",function(){IM._clip.setClientValue.call(this,that.h,0)},false);IM.tk.addEvent(that.h,"keyup",function(){IM._clip.setClientValue.call(this,that.w,1)},false)},setClientValue:function(node,flag){var temp=this.value.trim(),x=parseInt(node.value.trim(),10),reg=/^(?!0)\d+$/g;(0===flag&&reg.test(temp))&&(isNaN(x)?IMC.areaSize[1]:x,temp=temp>IM.canvas.width?(IM.canvas.width):temp,this.value=temp,IM._clip.areaCut(temp,x));(1===flag&&reg.test(temp))&&(isNaN(x)?IMC.areaSize[0]:x,temp=temp>IM.canvas.height?(IM.canvas.height):temp,this.value=temp,IM._clip.areaCut(x,temp))},finishClip:function(O){O.disabled="disabled";IM._clip.getImage();IM._clip.removeArea(function(){O.removeAttribute("disabled")});return false},destroy:function(){this.button.disabled="true";IM.tk.removeEvent(document,"keypress",this.keybordCut,false);IM.tk.removeEvent(this.radioA,"click",that.areaSet,false);IM.tk.removeEvent(this.radioB,"click",that.areaSet,false);try{IM._scale.destroy()}catch(e){}}};IM._scale={x:1,y:1,scaleDW:"scaleDW",scaleDH:"scaleDH",scaleDS:"scaleDS",scaleCS:"scaleCS",scaleCW:"scaleCW",scaleCH:"scaleCH",locked:"scaleLocked",scaleRest:"scaleRest",canvas:null,init:function(){try{IM.clip.area&&IM._clip.removeArea()}catch(e){}var that=IM._scale,canvas=IM.canvas,cxt=IM.canvas.getContext("2d");that.canvas=canvas;that.dw=doc.getElementById(that.scaleDW),that.dh=doc.getElementById(that.scaleDH);that.ds=doc.getElementById(that.scaleDS),that.cs=doc.getElementById(that.scaleCS);that.cw=doc.getElementById(that.scaleCW),that.ch=doc.getElementById(that.scaleCH);that.lock=doc.getElementById(that.locked);that.rest=doc.getElementById(that.scaleRest);that.dw.innerHTML=canvas.width;that.dh.innerHTML=canvas.height;IM.img.src=canvas.toDataURL("image/jpeg");that.w=canvas.width;that.h=canvas.height;that.button=doc.getElementById("Button"+IM.editing);that.cw.value="100";that.ch.value="100";IM.tk.addEvent(that.cw,"change",function(){that.restButton()},false);IM.tk.addEvent(that.ch,"change",function(){that.restButton()},false);that.restButton();that.upInfo(canvas.width,canvas.height);IM.tk.addEvent(that.rest,"click",that.restIamge,false);that.addEvent()},restButton:function(){IM.workSpace.buttonReset(this.button)},upInfo:function(w,h,l){w=w||0,h=h||0,l=l||0;this.dw.innerHTML=w;this.dh.innerHTML=h},restIamge:function(){var that=IM._scale;that.x=1;that.y=1;that.setScale()},addEvent:function(){var that=IM._scale;that.container=doc.getElementById(IMC.canvasContainer);that.wheel=navigator.userAgent.indexOf("Firefox")!==-1?"DOMMouseScroll":"mousewheel";IM.tk.addEvent(that.cw,"keyup",that.clientValue,false);IM.tk.addEvent(that.ch,"keyup",that.clientValue,false);IM.tk.addEvent(that.container,that.wheel,that.zoom,false)},clientValue:function(e){e=IM.tk.getEvent(e);var that=IM._scale,target=IM.tk.getTarget(e),value=parseInt(target.value.trim(),10),reg=/\d+/,checked=that.locked;value=Math.max(value,1);value=Math.min(value,IMW.scaleType);value=isNaN(value)?0:value;target.value=value;if(target===that.cw&&reg.test(value)){that.correctXY(value,that.ch)}else{if(target===that.ch&&reg.test(value)){that.correctXY(value,that.cw)}}that.x/=100;that.y/=100;that.setScale(1)},correctXY:function(value,b){var that=IM._scale;that.x=value;if(that.lock.checked===true){that.y=value;b.value=isNaN(value)?10:value}else{that.y=parseInt(b.value,10)}},zoom:function(e){e=tk.getEvent(e);IM._scale.getScale((e.wheelDelta?e.wheelDelta/(-120):(e.detail||0)/3)*(IMW.zoom));IM._scale.setScale()},setScale:function(src){var that=IM._scale,canvas=IM.canvas,cxt=IM.canvas.getContext("2d"),img=IM.img,x=Math.ceil(that.x),y=Math.ceil(that.y),w=Math.max(img.width*that.x,1),h=Math.max(img.height*that.y,1);w=parseInt(w,10),h=parseInt(h,10);if(IMW.scaleLock){w=Math.min(w,IM.availSize[0]),h=Math.min(h,IM.availSize[1]);if(w===IM.availSize[0]||h===IM.availSize[1]){return false}}IMW.scaleDataSize===true&&this.upInfo(w,h,canvas.toDataURL("image/jpeg").length);cxt.clearRect(0,0,canvas.width,canvas.height);cxt.scale(that.x,that.y);canvas.width=w;canvas.height=h;src===1||(that.ch.value=parseInt(Math.ceil(w/that.w*100),10),that.cw.value=parseInt(Math.ceil(h/that.h*100),10));that.dw.innerHTML=isNaN(w)?1:w;that.dh.innerHTML=isNaN(h)?1:h;cxt.drawImage(img,0,0,w,h)},getScale:function(){function zoom(s,z){return s>0&&s>-z?z:s<0&&s<z?-z:0}return function(z){if(z){var hZoom=zoom(this.y,z),vZoom=zoom(this.x,z);if(hZoom&&vZoom){this.y+=hZoom,this.x+=vZoom;this.x=Math.min(this.x,IMW.scaleType/100);this.y=Math.min(this.y,IMW.scaleType/100)}}}}(),destroy:function(){var that=this;this.button.disabled="true";IM.tk.removeEvent(that.rest,"click",that.restIamge,false);try{IM.tk.removeEvent(that.container,that.wheel,that.zoom,false)}catch(e){}}};IM._rotate={a:1,b:-1,m:0,canvas:null,init:function(){try{IM.clip.area&&IM._clip.removeArea();IM._scale.destroy()}catch(e){}var that=IM._rotate,canvas=IM.canvas,cxt=IM.canvas.getContext("2d");that.canvas=canvas;that.handers=doc.getElementById(IMW.rotateHandler);that.r=0;that.button=doc.getElementById("Button"+IM.editing);IM.img.src=canvas.toDataURL("image/jpeg");IM.tk.addEvent(that.handers,"click",that.addEvent,false)},restButton:function(){IM.workSpace.buttonReset(this.button)},addEvent:function(e){e=tk.getEvent(e);var that=IM._rotate,target=tk.getTarget(e),t=null;if(target.nodeType===1&&target.nodeName.toLowerCase()==="img"){t=target.getAttribute("alt");({l:function(){(that.m==0)?that.m=3:that.m--;that.left();that.setRotate(1)},r:function(){(that.m==3)?that.m=0:that.m++;that.right();that.setRotate(1)},v:function(){that.a*=-1,that.b*=-1,that.vertical(),that.setRotate()},h:function(){that.b*=-1,that.a*=-1,that.horizontal(),that.setRotate()}})[t]()}IM.tk.stopEvent(e)},vertical:function(){this.r=Math.PI-this.r},horizontal:function(){this.r=Math.PI-this.r},rotate:function(n){this.r=n},left:function(){this.r-=Math.PI/2},right:function(){this.r-=Math.PI/2},setRotate:function(n){var that=IM._rotate,canvas=IM.canvas,cxt=IM.canvas.getContext("2d"),img=IM.img,rules=null,w=img.width,h=img.height;cxt.clearRect(0,0,canvas.width,canvas.height);cxt.save();rules={0:function(){canvas.setAttribute("width",w);canvas.setAttribute("height",h);cxt.rotate(0*Math.PI/180);cxt.drawImage(img,0,0)},1:function(){canvas.setAttribute("width",h);canvas.setAttribute("height",w);cxt.rotate(90*Math.PI/180);cxt.drawImage(img,0,-h)},2:function(){canvas.setAttribute("width",w);canvas.setAttribute("height",h);cxt.rotate(180*Math.PI/180);cxt.drawImage(img,-w,-h)},3:function(){canvas.setAttribute("width",h);canvas.setAttribute("height",w);cxt.rotate(270*Math.PI/180);cxt.drawImage(img,-w,0)}};n&&(rules)[that.m]();n||(cxt.transform(that.a,0,0,that.b,0,0),cxt.drawImage(img,-w,0));cxt.restore()},destroy:function(){this.button.disabled="true";IM.tk.removeEvent(this.handers,"click",this.addEvent,false)}};IM._mark={init:function(){try{IM.clip.area&&(IM._clip.removeArea());IM._scale.destroy()}catch(e){}var that=IM._mark,canvas=IM.canvas;that.cxt=IM.canvas.getContext("2d");that.canvas=canvas;IM.img.src=canvas.toDataURL("image/jpeg");that.markers=doc.getElementById(IMW.watermarkCon);that.control||(that.control=null);that.preview||(that.preview=null);that.xy||(that.xy=null);that.markSrc||(that.markSrc=null);that.handers=doc.getElementById(IMW.watermarkControl);that.preview=IM.tk.getHtmlElement("canvas");IM.markPreview=that.preview;that.content=that.preview.getContext("2d");that.buttons=doc.getElementById("watermarkControl").getElementsByTagName("input");that.button=doc.getElementById("Button"+IM.editing);that.markerList=that.markers.getElementsByTagName("li");that.buttonInit.call(that);IM.tk.addEvent(that.handers,"click",that.addEvent,false);IM.tk.addEvent(that.markers,"click",that.markersEvent,false);IM.tk.trigger(that.buttons[that.buttons.length-1],"click");IM.tk.trigger(doc.getElementById(IMW.watermarkCon).getElementsByTagName("img")[0],"click");that.restButton()},restButton:function(){IM.workSpace.buttonReset(this.button)},hiddenMark:function(){this.markers.style.visibility="hidden";this.cancel.style.visibility="hidden"},buttonInit:function(){IM.tk.each(this.button,function(a,b){b.className=""})},getWatermark:function(src,alpha){var that=IM._mark,markImg=new Image,content=null;markImg.onload=function(){that.preview.width=this.width;that.preview.height=this.height;that.content.drawImage(markImg,0,0);var IMG=that.content.getImageData(0,0,this.width,this.height),data=IMG.data,len=data.length,i=3;markImg.src=null;markImg.onload=null;IMG.data=data;that.content.putImageData(IMG,0,0);that.markSrc=that.preview.toDataURL()};markImg.src=src;that.cxt.restore()},getWatermarkOpacity:function(e){e=IM.tk.getEvent(e);var that=IM._mark,target=IM.tk.getTarget(e),value=parseInt(this.value,10);value>=100&&(this.value=100);value<0&&(this.value=0);if(!isNaN(value)&&value>=0){value>=100&&(this.value=100);that.opacity=value}that.getWatermark(that.markSrc,that.opacity)},addEvent:function(e){e=IM.tk.getEvent(e);var target=IM.tk.getTarget(e),that=IM._mark;if(target.nodeType===1&&target.nodeName.toLowerCase()==="input"){that.control=target.id.replace(/wm/g,"");that.buttonInit.call(that);IM.tk.each(that.buttons,function(a,b){b.className=""});that.button.disabled===true&&(that.restButton());target.className="markPosition"}},markersEvent:function(e){var target=IM.tk.getTarget(e),that=IM._mark;if(target.nodeType===1&&target.nodeName.toLowerCase()==="img"){({waterMark:function(){IM.tk.each(that.markerList,function(a,b){b.removeAttribute("class")});that.button.disabled===true&&(that.restButton());target.parentNode.className="watermarkHl";that.getWatermark(target.src)}})[target.className]()}},rules:{TL:function(w,h){return[10,10]},TC:function(w,h){return[(this.width-w)/2,10]},TR:function(w,h){return[this.width-w-10,10]},CL:function(w,h){return[10,(this.height-h)/2]},CC:function(w,h){return[(this.width-w)/2,(this.height-h)/2]},CR:function(w,h){return[this.width-w-10,(this.height-h)/2]},BL:function(w,h){return[10,this.height-h-10]},BC:function(w,h){return[(this.width-w)/2,this.height-h-10]},BR:function(w,h){return[this.width-w-10,this.height-h-10]}},previewMark:function(src){var that=this,img=new Image;img.onload=function(){that.xy=that.getXY(img);that.canvas.parentNode.appendChild(that.preview);that.preview.style.cssText="position:absolute;left:"+that.xy[0]+"px;top:"+that.xy[1]+"px;";that.content.drawImage(this,0,0)};img.src=src},getMark:function(){var that=IM._mark,temp=IM.config.dataURL.waterMark,parent=doc.getElementById(IMW.watermarkCon),ul=IM.tk.getHtmlElement("ul");parent.innerHTML="";IM.tk.dynamicScriptProxy(temp.url,temp.param,function(b){IM.tk.each(b,function(x,y){var li=IM.tk.getHtmlElement("li"),radio=IM.tk.getHtmlElement("input"),img=IM.tk.getHtmlElement("img");img.src=b[x].img;img.className="waterMark";li.appendChild(img);ul.appendChild(li)});parent.appendChild(ul)})},getXY:function(img){if(!this.control){return false}return this.rules[this.control].call(this.canvas,img.width,img.height)},uploadImg:function(){var that=this,img=new Image;if(that.markSrc==null){IM.dailog({name:"uploadTips",title:"\u63d0\u793a",html:"<p>\u8bf7\u9009\u62e9\u6c34\u5370!</p><p>2\u79d2\u540e\u81ea\u52a8\u5173\u95ed</p>",width:300,height:100},function(){var that=this;setTimeout(function(){that.removeDailog()},2000)});setTimeout(function(){IM.workSpace.buttonReset(that.button)},200);return false}img.onload=function(){that.xy=that.getXY(img);if(that.xy===false){IM.dailog({name:"uploadTips",title:"\u63d0\u793a",html:"<p>\u8bf7\u9009\u62e9\u6c34\u5370\u4f4d\u7f6e!</p><p>2\u79d2\u540e\u81ea\u52a8\u5173\u95ed</p>",width:300,height:100},function(){var that=this;setTimeout(function(){that.removeDailog()},2000)});IM.workSpace.buttonReset(that.button);return false}that.cxt.drawImage(img,that.xy[0],that.xy[1]);that.button.disabled="true"};img.src=that.markSrc},removePreview:function(){var that=this;try{that.canvas.parentNode.removeChild(that.preview);that.preview.width=0,that.preview.height=0}catch(e){}},destroy:function(){this.uploadImg()}};IM.tk.addEvent(window,"load",function(){},false);if(window===this||"indicator" in this){return new indicator}};imageMagic.workSpace||(imageMagic.workSpace=new WorkSpace())}(window);

